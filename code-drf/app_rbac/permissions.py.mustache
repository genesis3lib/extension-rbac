from rest_framework.permissions import BasePermission
from .models import UserRole


def _has_role(user, role):
    """
    Check if user has a specific role.
    Works with both Auth User objects (Auth0User, OktaUser, StytchUser)
    and database User objects.
    """
    # Try has_role method first (works for both auth and db users)
    if hasattr(user, 'has_role'):
        return user.has_role(role)
    # Fallback to checking roles attribute directly
    if hasattr(user, 'roles'):
        return role in user.roles
    return False


def _is_admin(user):
    """Check if user is admin (works with both auth and db user objects)"""
    return _has_role(user, 'admin') or _has_role(user, UserRole.ADMIN)


def _is_root(user):
    """Check if user is root (works with both auth and db user objects)"""
    return _has_role(user, 'root') or _has_role(user, UserRole.ROOT)


class IsRoot(BasePermission):
    """
    Allows access only to root users.
    """
    message = "Root access required."

    def has_permission(self, request, view):
        if not request.user or not request.user.is_authenticated:
            return False
        return _is_root(request.user)


class IsAdmin(BasePermission):
    """
    Allows access only to admin users (including root).
    """
    message = "Admin access required."

    def has_permission(self, request, view):
        if not request.user or not request.user.is_authenticated:
            return False
        return _is_admin(request.user) or _is_root(request.user)


class IsAdminOrReadOnly(BasePermission):
    """
    Allows full access to admin users, read-only for others.
    """
    message = "Admin access required for write operations."

    def has_permission(self, request, view):
        if request.method in ('GET', 'HEAD', 'OPTIONS'):
            return True
        if not request.user or not request.user.is_authenticated:
            return False
        return _is_admin(request.user) or _is_root(request.user)


class HasRole(BasePermission):
    """
    Allows access only to users with specific roles.

    Usage:
        class MyView(APIView):
            permission_classes = [HasRole]
            required_roles = ['admin', 'manager']
    """
    message = "You do not have the required role."

    def has_permission(self, request, view):
        if not request.user or not request.user.is_authenticated:
            return False

        required_roles = getattr(view, 'required_roles', [])
        if not required_roles:
            return True

        return any(_has_role(request.user, role) for role in required_roles)


class IsOwnerOrAdmin(BasePermission):
    """
    Object-level permission to only allow owners of an object or admins to access it.

    Assumes the model instance has an `owner` attribute or `user` attribute.
    """
    message = "You must be the owner or an admin."

    def has_object_permission(self, request, view, obj):
        if not request.user or not request.user.is_authenticated:
            return False

        # Admins have full access
        if _is_admin(request.user) or _is_root(request.user):
            return True

        # Check if user owns the object
        owner = getattr(obj, 'owner', None) or getattr(obj, 'user', None)
        if owner:
            # Compare by id or external_auth_id
            user_id = getattr(request.user, 'id', None)
            return owner.id == user_id or (hasattr(owner, 'external_auth_id') and owner.external_auth_id == user_id)

        return False
