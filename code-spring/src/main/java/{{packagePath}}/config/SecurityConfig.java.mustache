package {{{javaPackageFull}}}.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfigurationSource;

/**
 * Security configuration for {{{projectName}}}
 *
 * Configures:
 * - Public vs protected endpoints
 * - JWT-based authentication
 * - Stateless session management
 * - Uses shared CORS configuration from CorsConfig
 *
 * NOTE: This config is only active when no custom auth provider is configured.
 * When app.auth.provider is set (e.g., auth0, okta, stytch), this config is disabled
 * and the provider's security configuration takes over.
 */
@Configuration
@EnableWebSecurity
@ConditionalOnProperty(name = "app.auth.provider", havingValue = "default", matchIfMissing = true)
@ConditionalOnProperty(name = "app.security.enabled", havingValue = "true", matchIfMissing = true)
public class SecurityConfig {

    @Value("${app.security.public-uris}")
    private String publicUris;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http, CorsConfigurationSource corsConfigurationSource) throws Exception {
        // Parse public URIs
        String[] publicUriPatterns = publicUris.split(",");

        http
            .cors(cors -> cors.configurationSource(corsConfigurationSource))
            .csrf(csrf -> csrf.disable())
            .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> {
                // Allow public endpoints
                for (String pattern : publicUriPatterns) {
                    auth.requestMatchers(pattern.trim()).permitAll();
                }
                // All other requests require authentication
                auth.anyRequest().authenticated();
            });

        return http.build();
    }
}
